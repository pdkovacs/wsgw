version: "3"

vars:
  DEV_LOG_FILE: '{{.DEV_LOG_FILE | default "$HOME/workspace/logs/e2e-app" }}'
  GOOS: linux
  GOARCH: amd64
  WEB_DIST_SOURCE: ../web/dist
  WEB_DIST_TARGET: ./web/dist

tasks:
  version-data:
    cmds:
      - echo "APPLICATION=WebSocket Gateway / End-to-end Test / Application" > internal/config/version_data.txt
      - echo VERSION=0.0.1 >> internal/config/version_data.txt
      - printf "TIME=" >> internal/config/version_data.txt
      - echo {{now}} >> internal/config/version_data.txt
      - printf "COMMIT=" >> internal/config/version_data.txt
      - git rev-parse HEAD >> internal/config/version_data.txt
  app:
    cmds:
      - task: version-data
      - |
        cd ./cmd
        GOOS=linux GOARCH=amd64 go build -tags lambda.norpc -o app ./...
  with-web:
    cmds:
      - rm -rf "{{.WEB_DIST_TARGET}}/{index.html,assets}" || echo "No files to remove in {{.WEB_DIST_TARGET}}"
      - cp -r {{.WEB_DIST_SOURCE}}/* {{.WEB_DIST_TARGET}}/
      - task: plain
  image:
    cmds:
      - task: app
      - |
        context_dir=./image
        repo_name=bitkit/wsgw-e2e-app
        cp ./cmd/app ./$context_dir/wsgw-e2e-app
        docker build $context_dir -t $repo_name
        if which minikube && minikube status;
        then
            eval "$(minikube docker-env)"
        fi
        docker build $context_dir -t $repo_name
  watch:
    cmds:
      - |
        # DynamoDB local
        DYNAMODB_URL=http://10.98.45.101:8000
        export AWS_ACCESS_KEY_ID=kalap
        export AWS_SECRET_ACCESS_KEY=kabat

        password_base=crixcrax
        nr_users=3
        mkdir -p $(dirname {{.DEV_LOG_FILE}})

        pwcreds="["
        for nummer in $(seq 1 30); do
          if test $nummer -gt 1; then
            pwcreds="${pwcreds},"
          fi
          pwcreds="${pwcreds}{\"username\":\"user${nummer}\",\"password\":\"${password_base}${nummer}\"}"
        done
        pwcreds="${pwcreds}]"
        echo "pwcreds: $pwcreds"

        export E2EAPP_SERVER_PORT=45678
        export E2EAPP_PASSWORD_CREDENTIALS="$pwcreds"
        export E2EAPP_WSGW_HOST=localhost
        export E2EAPP_WSGW_PORT=45679
        export E2EAPP_LOG_LEVEL=debug
        export E2EAPP_DEV_LOG_FILE="{{.DEV_LOG_FILE}}"

        export E2EAPP_OTLP_ENDPOINT="http://localhost:4318"
        export E2EAPP_OTLP_SERVICE_NAMESPACE="wsgw"
        export E2EAPP_OTLP_SERVICE_NAME="e2eapp"
        export E2EAPP_OTLP_SERVICE_INSTANCE_ID="started-by-watch"

        ./watch.sh
  run:
    cmds:
      - task: build
      - |
        password_base=crixcrax
        nr_users=3
        mkdir -p $(dirname {{.DEV_LOG_FILE}})

        pwcreds="["
        for nummer in $(seq 1 3); do
          if test $nummer -gt 1; then
            pwcreds="${pwcreds},"
          fi
          pwcreds="${pwcreds}{\"username\":\"user${nummer}\",\"password\":\"${password_base}${nummer}\"}"
        done
        pwcreds="${pwcreds}]"
        echo "pwcreds: $pwcreds"

        export E2EAPP_SERVER_PORT=45678
        export E2EAPP_PASSWORD_CREDENTIALS="$pwcreds"
        export E2EAPP_E2EAPP_WSGW_HOST=localhost
        export E2EAPP_E2EAPP_WSGW_PORT=45679
        export E2EAPP_E2EAPP_LOG_LEVEL=debug
        export E2EAPP_E2EAPP_DEV_LOG_FILE="{{.DEV_LOG_FILE}}"

        ./cmd/app | tee {{.DEV_LOG_FILE}}
