version: "3"

vars:
  DEV_LOG_FILE: '{{.DEV_LOG_FILE | default "$HOME/workspace/logs/e2e-app" }}'
  GOOS: linux
  GOARCH: amd64

tasks:
  buildinfo:
    cmds:
      - echo VERSION=0.0.1 > internal/config/buildinfo.txt
      - printf "TIME=" >> internal/config/buildinfo.txt
      - date +%Y-%m-%dT%H:%M:%S%z >> internal/config/buildinfo.txt
      - printf "COMMIT=" >> internal/config/buildinfo.txt
      - git rev-parse HEAD >> internal/config/buildinfo.txt
  build:
    cmds:
      - task: buildinfo
      - |
        cd ./cmd
        GOOS=linux GOARCH=amd64 go build -tags lambda.norpc -o app ./...
  watch:
    cmds:
      - |
        # DynamoDB local
        DYNAMODB_URL=http://10.98.45.101:8000
        export AWS_ACCESS_KEY_ID=kalap
        export AWS_SECRET_ACCESS_KEY=kabat

        password_base=crixcrax
        nr_users=3
        mkdir -p $(dirname {{.DEV_LOG_FILE}})

        pwcreds="["
        for nummer in $(seq 1 30); do
          if test $nummer -gt 1; then
            pwcreds="${pwcreds},"
          fi
          pwcreds="${pwcreds}{\"username\":\"user${nummer}\",\"password\":\"${password_base}${nummer}\"}"
        done
        pwcreds="${pwcreds}]"
        echo "pwcreds: $pwcreds"

        export E2EAPP_SERVER_PORT=45678
        export E2EAPP_PASSWORD_CREDENTIALS="$pwcreds"
        export E2EAPP_WSGW_HOST=localhost
        export E2EAPP_WSGW_PORT=45679
        export E2EAPP_LOG_LEVEL=debug
        export E2EAPP_DEV_LOG_FILE="{{.DEV_LOG_FILE}}"

        export E2EAPP_OTLP_ENDPOINT="http://localhost:4318"
        export E2EAPP_OTLP_SERVICE_NAMESPACE="wsgw"
        export E2EAPP_OTLP_SERVICE_NAME="e2eapp"
        export E2EAPP_OTLP_SERVICE_INSTANCE_ID="started-by-watch"

        ./watch.sh
  run:
    cmds:
      - task: build
      - |
        password_base=crixcrax
        nr_users=3
        mkdir -p $(dirname {{.DEV_LOG_FILE}})

        pwcreds="["
        for nummer in $(seq 1 3); do
          if test $nummer -gt 1; then
            pwcreds="${pwcreds},"
          fi
          pwcreds="${pwcreds}{\"username\":\"user${nummer}\",\"password\":\"${password_base}${nummer}\"}"
        done
        pwcreds="${pwcreds}]"
        echo "pwcreds: $pwcreds"

        export E2EAPP_SERVER_PORT=45678
        export E2EAPP_PASSWORD_CREDENTIALS="$pwcreds"
        export E2EAPP_E2EAPP_WSGW_HOST=localhost
        export E2EAPP_E2EAPP_WSGW_PORT=45679
        export E2EAPP_E2EAPP_LOG_LEVEL=debug
        export E2EAPP_E2EAPP_DEV_LOG_FILE="{{.DEV_LOG_FILE}}"

        ./cmd/app | tee {{.DEV_LOG_FILE}}
