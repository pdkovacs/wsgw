version: "3"

vars:
  EXEC_NAME: wsgw-e2e-client
  GOOS: linux
  GOARCH: amd64

tasks:
  version-data:
    cmds:
      - echo "APPLICATION=WebSocket Gateway / End-to-end Test / Client" > internal/config/version_data.txt
      - echo VERSION=0.0.1 >> internal/config/version_data.txt
      - printf "TIME=" >> internal/config/version_data.txt
      - echo {{now}} >> internal/config/version_data.txt
      - printf "COMMIT=" >> internal/config/version_data.txt
      - git rev-parse HEAD >> internal/config/version_data.txt
  client:
    cmds:
      - task: version-data
      - |
        cd ./cmd
        GOOS=linux GOARCH=amd64 go build -tags lambda.norpc -o {{.EXEC_NAME}} ./...
  image:
    cmds:
      - task: client
      - |
        context_dir=./image
        repo_name=bitkit/{{.EXEC_NAME}}
        cp ./cmd/{{.EXEC_NAME}} ./$context_dir/{{.EXEC_NAME}}
        docker build $context_dir -t $repo_name
        if which minikube && minikube status;
        then
            eval "$(minikube docker-env)"
        fi
        docker build $context_dir -t $repo_name
