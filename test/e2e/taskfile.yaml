version: "3"

includes:
  app:
    taskfile: ./app/taskfile.yaml
    dir: ./app/
  client:
    taskfile: ./client/taskfile.yaml
    dir: ./client/
  k8s-impl:
    taskfile: ./deploy/k8s/taskfile.yaml
    dir: ./deploy/k8s

env:
  IMAGE_REPO: wsgw

tasks:
  ui:
    sources:
      - web/src/**/*
      - ./taskfile.yaml
    generates:
      - web/dist/assets/**
      - web/dist/index.html
    cmds:
      - |
        cd ./web
        npm install
        npm run build
  client-device:
    cmds:
      - |
        cd ./client-device/cmd
        GOOS=linux GOARCH=amd64 go build -tags lambda.norpc -o client-device main.go
  k8s:
    cmds:
      - task: app:image
      - task: k8s-impl:app
      - task: client:image
      - task: k8s-impl:client
  aws-deploy:
    cmds:
      - |
        . ${HOME}/.my-aws-config
        . ${HOME}/.wsgw-test-cognito.secrets
        cd ./deploy/aws/tf
        terragrunt apply --all --queue-include-external
        # terragrunt apply
  aws-destroy:
    cmds:
      - |
        . ${HOME}/.my-aws-config
        . ${HOME}/.wsgw-test-cognito.secrets
        cd ./deploy/aws/tf
        terragrunt destroy --all --queue-include-external
        # terragrunt apply
